name: Move to Production

on:
  push:
    branches:
      - main  # Trigger deployment on push to main

env:
  REPO_NAME: ${{ github.repository }}

jobs:
  # Validate build before triggering Render deployment
  validate-build:
    name: Validate Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint
        continue-on-error: true

      - name: Build project
        run: npm run build

      - name: Verify build output
        run: |
          if [ ! -d "dist" ]; then
            echo "‚ùå Build failed - dist directory not found"
            exit 1
          fi
          echo "‚úÖ Build successful - ready to deploy"

      # Send error email if validation fails
      - name: Send build error email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ùå Build Error - ${{ env.REPO_NAME }}"
          to: ${{ secrets.MAIL_TO }}
          from: GitHub Actions <noreply@github.com>
          body: |
            ‚ùå Build validation failed

            Repository: ${{ env.REPO_NAME }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Message: ${{ github.event.head_commit.message }}
            Author: ${{ github.actor }}

            üîó View logs:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ‚ö†Ô∏è Deployment was NOT triggered. Please fix the errors and push again.
          priority: high

  # Trigger Render deployment (Render will build and deploy automatically)
  deploy-to-render:
    name: Deploy to Render
    needs: validate-build
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Render deployment
        id: deploy
        run: |
          echo "üöÄ Triggering Render deployment via webhook..."

          RESPONSE=$(curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" \
            -H "Content-Type: application/json" \
            -s -w "\n%{http_code}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "‚úÖ Render deployment triggered successfully!"
            echo "Render will now pull, build, and deploy your app"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Failed to trigger Render deployment (HTTP $HTTP_CODE)"
            echo "status=failed" >> $GITHUB_OUTPUT
            echo "error=$BODY" >> $GITHUB_OUTPUT
            exit 1
          fi

      # Send error email if deployment trigger fails
      - name: Send deployment error email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚ùå Deployment Error - ${{ env.REPO_NAME }}"
          to: ${{ secrets.MAIL_TO }}
          from: GitHub Actions <noreply@github.com>
          body: |
            ‚ùå Failed to trigger Render deployment

            Repository: ${{ env.REPO_NAME }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Message: ${{ github.event.head_commit.message }}
            Author: ${{ github.actor }}

            Error: ${{ steps.deploy.outputs.error }}

            üîó View workflow:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            üîó Check Render:
            https://dashboard.render.com

            Check the Render dashboard for more details.
          priority: high

      # Send success email
      - name: Send success email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: "‚úÖ Deploying to Production - ${{ env.REPO_NAME }}"
          to: ${{ secrets.MAIL_TO }}
          from: GitHub Actions <noreply@github.com>
          body: |
            ‚úÖ Render deployment triggered successfully!

            Repository: ${{ env.REPO_NAME }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Message: ${{ github.event.head_commit.message }}
            Author: ${{ github.actor }}

            üîó View workflow:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            üîó Monitor deployment:
            https://dashboard.render.com

            ‚è±Ô∏è Your site will be live in 2-3 minutes!
          priority: normal
